<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Electricity Forecast Heatmap (Plotly)</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #controls {
            margin-bottom: 20px;
        }

        select {
            padding: 5px;
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <h1>Electricity Availability Heatmap</h1>
    <div id="controls">
        <label>Station:
            <select id="stationSelect"></select>
        </label>
        <label>Exit:
            <select id="exitSelect"></select>
        </label>
    </div>

    <div id="heatmap" style="width:100%;max-width:900px;height:600px;"></div>

    <script>
        let forecastsData = [];

        fetch('all_forecasts_optimized.json')
            .then(res => res.json())
            .then(data => {
                forecastsData = data;
                populateStationSelect();
            });

        function populateStationSelect() {
            const stations = [...new Set(forecastsData.map(d => d.station))];
            const stationSelect = document.getElementById('stationSelect');
            stationSelect.innerHTML = stations.map(s => `<option value="${s}">${s}</option>`).join('');
            stationSelect.addEventListener('change', populateExitSelect);
            populateExitSelect();
        }

        function populateExitSelect() {
            const station = document.getElementById('stationSelect').value;
            const exits = forecastsData.filter(d => d.station === station).map(d => d.exit);
            const exitSelect = document.getElementById('exitSelect');
            exitSelect.innerHTML = exits.map(e => `<option value="${e}">${e}</option>`).join('');
            exitSelect.addEventListener('change', updateChart);
            updateChart();
        }

        function updateChart() {
            const station = document.getElementById('stationSelect').value;
            const exit = document.getElementById('exitSelect').value;
            const selected = forecastsData.find(d => d.station === station && d.exit === exit);
            if (!selected) return;

            const dayOrder = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            // Create a 7 x 24 grid for days x hours
            let z = Array(7).fill().map(() => Array(24).fill(null));

            selected.forecast.forEach(f => {
                const dayIndex = dayOrder.indexOf(f.day);
                z[dayIndex][f.hour] = f.has_power;
            });

            const trace = {
                z: z,
                x: dayOrder,
                y: Array.from({ length: 24 }, (_, i) => i),

                type: 'heatmap',
                colorscale: [
                    [0, 'rgba(200,0,0,0.8)'],  // red for no power
                    [1, 'rgba(0,200,0,0.8)']   // green for power
                ],
                reversescale: false,
                showscale: true
            };

            const layout = {
                title: `${station} â€” ${exit}`,
                yaxis: { title: 'Hour of Day', dtick: 1 },
                xaxis: { title: 'Day of Week', automargin: true },
                margin: { t: 50, l: 80, r: 20, b: 50 }
            };

            Plotly.newPlot('heatmap', [trace], layout, { responsive: true });
        }
    </script>

</body>

</html>